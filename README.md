# allen-dataverse-client

A Python client library for interacting with Dataverse operations through PowerAutomate flows.

## Auto-generated Client Code
- The client is autogenerated using an openapi generator.
- The client can be pip installed as `pip install aind-dataverse-client`

## Contributing

This package is generated from PowerAutomate flows and OpenAPI specifications. The overall architecture is: 

```
Dataverse → PowerAutomate Flows → OpenAPI Spec → Generated Python Client
```

To contribute: 

### 1. Update/Create PowerAutomate Flows

- Navigate to PowerAutomate and locate the relevant flow
- Make necessary changes to the flow logic, inputs, or outputs in PowerAutomate editor. 
- Test the flow to ensure it works as expected.
- Note any changes to input/output schemas

### 2. Update OpenAPI Specification

- Edit `openapi.yaml` to reflect changes made to the PowerAutomate flows through the PowerAutomate Custom Connector UI (named: "allen-dataverse-client"). More on this below.
- Update paths, parameters, request/response schemas as needed
- Note: The `openapi.yaml` was created using PowerAutomate Custom Connector.

### 3. Generate the Client
```bash
docker run --rm \
  -v "$(pwd)":/local \
  openapitools/openapi-generator-cli generate \
  -i /local/openapi.yaml \
  -g python \
  -o /local/python-client \
  -c /local/openapirc_python_client.json \
  --ignore-file-override /local/.openapi-generator-ignore
```

### 4. Using the Client

#### Install
```bash
pip install -e ./allen-dataverse-client
pip install requests
```

#### Basic Usage
```python
import os
import requests
from allen_dataverse_client import DefaultApi, Configuration, ApiClient, FetchProjectByNameRequest

# Get OAuth token
token_url = f"https://login.microsoftonline.com/{os.environ['DATAVERSE_TENANT_ID']}/oauth2/v2.0/token"
payload = {
    'grant_type': 'client_credentials',
    'client_id': os.environ['DATAVERSE_CLIENT_ID'],
    'client_secret': os.environ['DATAVERSE_CLIENT_SECRET'],
    'scope': 'https://service.flow.microsoft.com//.default'
}
token = requests.post(token_url, data=payload).json()['access_token']

# Configure client
config = Configuration()
config.host = f"https://{os.environ['DATAVERSE_HOST']}"
config.access_token = token
api = DefaultApi(ApiClient(config))

# Use the client to fetch project data
response = api.fetch_project_by_name(
    api_version=1,
    body=FetchProjectByNameRequest(project_name="CCF Template")
)

# Use the client to fetch table names
response = api.fetch_table_names(
  api_version=1
)

# Use the client to fetch full table data
response = api.fetch_table_by_name(
  api_version=1,
  body={"tableName": "cr138_projects"}
)

```
Note: Note that the body for each of these actions can either be a dictionary with required params, or an object generated by the client (ex: `FetchProjectByNameRequest`). See generated client for more details. 

### Production Usage

For production deployments, consider implementing:
- **Token caching** to avoid frequent token requests
- **Wrapper class** to encapsulate OAuth logic

## Available Endpoints

- **`fetch_project_by_name`** - Fetch project data by project name
- **`fetch_table_by_name`** - Fetch table data by table name  
- **`fetch_table_names`** - Fetch all custom table names in the environment

All endpoints use PowerAutomate workflow IDs as path parameters, making them configurable across different environments (dev/prod) via environment variables.
